function chisq = fit31PMAS(inputs)%% called by fmins from OR_main% % function minimized in fitting 31P (oriented)% MAS spectra. inputs: %	angle%	spread%	iso%	lb%	scale%	offset%global OR_iso_spect OR_angl_spect ExpData Variance holdAngleglobal BetaAngles OR_sw OR_wrot SimSpect OR_cut SidebandMax OR_angleangl = abs(rem(inputs(1), pi)); spread = abs(rem(inputs(2),pi)); iso = abs(inputs(3)); lb = 100*inputs(4); scale = inputs(5); offset = inputs(6);npts = length(ExpData); if holdAngle == 0 % use globals to fix angle to original value. angl = OR_angle;end% weight and normalize angular simulations% Gaussian parameters (angl,spread) are minimization variablesGaussianWeights = calcGaussian(BetaAngles, angl, spread);stick_array = ArrXMat(GaussianWeights, OR_angl_spect);OR_stickspec = sum(stick_array); OR_stickspec = OR_stickspec/norm(OR_stickspec);% combine angular, isotropic simulations% weighting (iso) is minimization variablefullstick = iso*OR_iso_spect + (1-iso)*OR_stickspec;% expand to full spectrum for comparison with experimental% note: 512 refers to number of angles used in simulations (N in simbasis)simspect = stick2spect(fullstick, npts, OR_sw, OR_wrot, SidebandMax, 512);% line broadening (lb) is a minimization variablewindow = LorentzBroad(npts,lb,OR_sw);simspect = applybroad(simspect,window);% account for isotropic shift of 31P peak%if wiso_shift < 0 ;% remember: ppm scale is backwards!% simspect = [simspect(n_pts +wiso_shift:n_pts),simspect(1:(n_pts-1)+wiso_shift)];%elseif wiso_shift > 0;%OR_cutsimspect = [simspect(OR_cut:npts),simspect(1:(OR_cut-1))];% renormalize spectrumsimspect = simspect - mean([simspect(1:200)]);simspect = simspect/norm(simspect);% allow slight variations for a better fitsimspect = offset + scale*simspect; SimSpect = real(simspect');%chisq = X2([ExpData(7000:10000)], [SimSpect(7000:10000)], Variance)chisq = X2(ExpData, SimSpect, Variance)