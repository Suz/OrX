% OR_main%% m_file for fitting 31P spectra of oriented spinning samples% SRKiihne 10-02-2004%% declare globalsglobal OR_iso_spect OR_angl_spect global ExpData Expsize Varianceglobal CrystalliteList BetaAngles anglsglobal OR_sw OR_freq OR_wrot OR_cut RFoffsetglobal SimSpect SidebandMax OR_init;OR_simbasis;% calculate isotropic spectrumOR_iso_spect = OR_calciso(CrystalliteList);OR_iso_spect = OR_iso_spect./norm(OR_iso_spect);% calculate oriented spectra: %  director orientation +/- 5*mosaic spread%  500 spectra total; beta in small steps, alpha randomOR_angl_spect = OR_calcspect(BetaAngles);GaussianWeights = calcGaussian(BetaAngles, OR_angle, OR_mosaic_spread);% call minimization routinestartvals = [OR_angle, OR_mosaic_spread, OR_frac_isotropic, OR_broadening/100, 1.3, -6e-4];fitvals = fmins('fit31PMAS',startvals,fit_params);if holdAngle == 0 fitvals(1) = OR_angle;endfitvals %print results to screenfinal_chi = X2(ExpData, SimSpect, Variance)residuals = ExpData - SimSpect; % calculate residuals% calculate axesspect_ax = linspace(-OR_sw/2, OR_sw/2, Expsize);ppmax = 1e6*(RFoffset + spect_ax/(OR_freq));% plot results: ppmplot function takes care of axis reversalhold offpretty = max(ExpData);ppmplot(ppmax, residuals); % hold onppmplot(ppmax, ExpData+(0.2*pretty));ppmplot( ppmax, SimSpect+(1.4*pretty) ); set(gca,'xcolor', [0 0 0]); set(gca,'ycolor',[1 1 1]);set(gca,'box', 'off');hold off% write reportcomment = OR_reporter(fitvals, final_chi);% save results to file outputfilenameeval(['save ' resultsfile ' ExpData SimSpect residuals ppmax -append']);%save resultsfile ExpData SimSpect residuals ppmax -append